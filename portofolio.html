<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir Cloud - XI TJKT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .dark-card { background: #121212; color: white; border-radius: 32px; }
        .hidden { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div id="login-page" class="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-blue-700 to-indigo-900">
        <div class="max-w-md w-full glass p-10 rounded-[40px] shadow-2xl text-center">
            <div class="w-20 h-20 bg-blue-500 rounded-3xl mx-auto flex items-center justify-center mb-6 rotate-12 text-white text-3xl font-extrabold shadow-lg text-white">T</div>
            <h1 class="text-3xl font-extrabold text-slate-800">TJKT POS</h1>
            <input type="text" id="username" placeholder="Nama Anda / 'admin'" class="w-full p-4 rounded-2xl border-2 border-slate-100 my-6 text-center font-bold outline-none focus:border-blue-500 transition-all">
            <button onclick="handleLogin()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-extrabold hover:bg-blue-600 shadow-lg transition-all">Masuk</button>
        </div>
    </div>

    <div id="main-dashboard" class="hidden">
        <header class="p-6 flex justify-between items-center glass sticky top-0 z-50 px-4 md:px-10">
            <div>
                <h2 id="role-title" class="text-[10px] font-bold uppercase tracking-widest text-blue-600">Pelanggan</h2>
                <h3 class="text-xl font-extrabold text-slate-800">XI TJKT Store</h3>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-3 bg-white py-2 px-4 rounded-full shadow-sm border border-slate-100">
                    <span id="display-name" class="font-bold text-sm uppercase text-slate-700">User</span>
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-indigo-500 rounded-full"></div>
                </div>
                <button onclick="handleLogout()" class="bg-red-50 text-red-500 p-2.5 rounded-full hover:bg-red-500 hover:text-white transition-all shadow-sm group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor font-bold"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                </button>
            </div>
        </header>

        <main class="p-6 max-w-7xl mx-auto flex flex-col lg:flex-row gap-8">
            <div class="flex-1">
                <div class="flex justify-between items-center mb-8">
                    <h4 class="text-2xl font-extrabold tracking-tight">Daftar Menu</h4>
                    <div class="flex gap-2">
                        <button id="admin-view-orders" onclick="toggleOrderMonitor()" class="hidden bg-slate-900 text-white px-5 py-2.5 rounded-2xl font-bold shadow-lg text-sm italic">Monitor Order üõ∞Ô∏è</button>
                        <button id="admin-add-btn" onclick="openAddProductModal()" class="hidden bg-blue-600 text-white px-5 py-2.5 rounded-2xl font-bold shadow-lg text-sm">+ Produk</button>
                    </div>
                </div>
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="sidebar-section" class="w-full lg:w-96">
                <div id="cart-section" class="dark-card p-8 sticky top-28 shadow-2xl border border-white/10">
                    <h4 class="text-xl font-bold mb-6 flex items-center gap-2">Keranjang <span id="cart-count" class="bg-blue-500 text-[10px] px-2.5 py-1 rounded-full">0</span></h4>
                    <div id="cart-items" class="space-y-4 mb-8 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                        <p class="text-slate-500 text-center text-sm italic">Kosong...</p>
                    </div>
                    <div class="flex justify-between font-bold text-xl mb-8 pt-6 border-t border-white/10">
                        <span>Total</span>
                        <span id="total-price" class="text-blue-400">Rp 0</span>
                    </div>
                    <button onclick="checkout()" class="w-full bg-blue-500 text-white py-4 rounded-2xl font-extrabold hover:bg-blue-400 shadow-xl transition-all shadow-blue-500/20">Bayar Sekarang</button>
                </div>

                <div id="admin-order-section" class="hidden glass p-8 sticky top-28 shadow-2xl rounded-[32px] border-2 border-blue-100">
                    <div class="flex justify-between items-center mb-6">
                        <h4 class="text-xl font-extrabold text-slate-800 tracking-tight">Pesanan Baru üõéÔ∏è</h4>
                        <button onclick="loadOrders()" class="text-blue-600 hover:rotate-180 transition-all duration-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg></button>
                    </div>
                    <div id="order-monitor-list" class="space-y-4 max-h-[450px] overflow-y-auto pr-2 custom-scrollbar">
                        <p class="text-slate-400 text-center text-xs py-10 italic">Mengambil data...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwreSzyGvv8creSoDUN_62weoM3f0zCSSmKIjVgSftwkPxdJYoHzHPd1VRtDmOqLsnm/exec"; 
    
    let products = [];
    let cart = [];

    window.onload = () => {
        const savedUser = localStorage.getItem('activeUser');
        if (savedUser) {
            document.getElementById('username').value = savedUser;
            handleLogin();
        }
    };

    async function loadProducts() {
        try {
            const res = await fetch(SCRIPT_URL + "?v=" + Date.now());
            const data = await res.json();
            products = data;
            renderProducts();
        } catch (err) {
            Swal.fire('Error', 'Gagal ambil data.', 'error');
        }
    }

    // FITUR MONITOR ORDER UNTUK ADMIN
    async function loadOrders() {
        const monitorList = document.getElementById('order-monitor-list');
        monitorList.innerHTML = '<div class="text-center py-10 text-xs font-bold text-slate-400 animate-pulse">Sinkronisasi...</div>';
        
        try {
            const res = await fetch(SCRIPT_URL + "?v=" + Date.now() + "&action=get_orders");
            const data = await res.json();
            
            // Urutan terbaru di atas
            const orders = data.reverse();

            if (orders.length === 0) {
                monitorList.innerHTML = '<div class="text-center py-10"><p class="text-slate-400 text-xs italic">Belum ada pesanan.</p></div>';
                return;
            }

            monitorList.innerHTML = orders.map(o => `
                <div class="bg-white p-5 rounded-[32px] border-2 border-slate-50 shadow-sm mb-4 relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-black text-blue-600 text-xs uppercase tracking-tighter">${o.nama_pelanggan || o.user}</span>
                        <button onclick="finishOrder(${o.rowId})" class="bg-green-500 text-white p-2 rounded-xl hover:bg-green-600 transition-all shadow-lg active:scale-90">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                        </button>
                    </div>
                    <div class="pr-10">
                        <p class="text-[13px] text-slate-700 font-extrabold leading-tight mb-2 uppercase">${o.detail_order || o.detail}</p>
                        <div class="flex justify-between items-center mt-3 pt-2 border-t border-slate-50">
                            <span class="text-[9px] text-slate-400 font-bold">${o.tanggal ? new Date(o.tanggal).toLocaleTimeString() : '-'}</span>
                            <span class="text-xs font-black text-slate-900 tracking-tighter">Rp ${Number(o.total_bayar || o.total).toLocaleString('id-ID')}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (err) {
            monitorList.innerHTML = '<p class="text-red-400 text-center text-[10px] font-bold py-10 uppercase">Error Koneksi</p>';
        }
    }

    async function finishOrder(rowId) {
        const confirm = await Swal.fire({
            title: 'Selesai?',
            text: "Pesanan akan dihapus dari monitor.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#22c55e',
            confirmButtonText: 'Ya!'
        });

        if (confirm.isConfirmed) {
            Swal.fire({ title: 'Menghapus...', didOpen: () => Swal.showLoading() });
            await sendData({ action: 'delete_order', rowId: rowId });
            setTimeout(() => {
                loadOrders();
                Swal.fire({ icon: 'success', title: 'Berhasil!', timer: 1000, showConfirmButton: false });
            }, 1500);
        }
    }
    function renderProducts() {
        const list = document.getElementById('product-list');
        const isAdmin = localStorage.getItem('activeUser') === 'admin';
        
        list.innerHTML = products.map(p => {
            const oriPrice = Number(p.price);
            const disc = Number(p.discount || 0);
            const finalPrice = oriPrice - disc;
            
            return `
                <div class="glass p-5 rounded-[35px] relative group border border-white shadow-sm">
                    ${isAdmin ? `
                        <div class="absolute top-4 right-4 flex gap-2 z-10">
                            <button onclick="editProduct(${p.id})" class="bg-blue-500 text-white w-8 h-8 rounded-full shadow-lg hover:scale-110 transition-all text-xs">‚úé</button>
                            <button onclick="deleteProduct(${p.id})" class="bg-red-500 text-white w-8 h-8 rounded-full shadow-lg hover:scale-110 transition-all text-xs">√ó</button>
                        </div>
                    ` : ''}
                    <div class="h-40 bg-slate-100 rounded-3xl mb-4 overflow-hidden">
                        <img src="${p.img}" class="w-full h-full object-cover group-hover:scale-105 transition-all">
                    </div>
                    <h5 class="font-black text-slate-800 uppercase text-sm">${p.name}</h5>
                    
                    <div class="mt-1">
                        ${disc > 0 ? `
                            <span class="text-[10px] text-red-500 line-through font-bold">Rp ${oriPrice.toLocaleString()}</span>
                            <p class="text-blue-600 font-black text-lg tracking-tighter">Rp ${finalPrice.toLocaleString()}</p>
                        ` : `
                            <p class="text-blue-600 font-black text-lg tracking-tighter">Rp ${oriPrice.toLocaleString()}</p>
                        `}
                    </div>
                    
                    <div class="mt-4 flex justify-between items-center border-t border-slate-50 pt-3">
                        <span class="text-[9px] font-bold text-slate-400">STOK: ${p.stock}</span>
                        <button onclick="addToCart(${p.id})" class="bg-slate-900 text-white w-10 h-10 rounded-2xl hover:bg-blue-600 transition-all">+</button>
                    </div>
                </div>
            `;
        }).join('');
    }

async function editProduct(id) {
        const p = products.find(x => x.id == id);
        const { value: f } = await Swal.fire({
            title: 'Edit Menu',
            html: `
                <div class="text-left space-y-3 p-2">
                    <div>
                        <label class="text-[10px] font-bold text-blue-600 uppercase">Nama Produk</label>
                        <input id="en" class="w-full p-3 mt-1 rounded-xl border border-slate-200 font-bold" value="${p.name}">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-blue-600 uppercase">Harga Ori</label>
                            <input id="ep" type="number" class="w-full p-3 mt-1 rounded-xl border border-slate-200 font-bold" value="${p.price}">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-red-500 uppercase">Potongan Harga</label>
                            <input id="ed" type="number" class="w-full p-3 mt-1 rounded-xl border border-slate-200 font-bold text-red-500" value="${p.discount || 0}" placeholder="0">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-blue-600 uppercase">Stok</label>
                        <input id="es" type="number" class="w-full p-3 mt-1 rounded-xl border border-slate-200 font-bold" value="${p.stock}">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-blue-600 uppercase">Link Gambar</label>
                        <input id="ei" class="w-full p-3 mt-1 rounded-xl border border-slate-200 text-xs" value="${p.img}">
                    </div>
                </div>
            `,
            confirmButtonText: 'Update Data',
            showCancelButton: true,
            preConfirm: () => {
                return {
                    name: document.getElementById('en').value,
                    price: document.getElementById('ep').value,
                    discount: document.getElementById('ed').value || 0,
                    stock: document.getElementById('es').value,
                    img: document.getElementById('ei').value
                }
            }
        });

        if (f) {
            Swal.fire({ title: 'Menyimpan Perubahan...', didOpen: () => Swal.showLoading() });
            await sendData({ action: 'edit', id: id, ...f });
            setTimeout(() => { loadProducts(); Swal.fire('Berhasil!', 'Data produk diperbarui.', 'success'); }, 1500);
        }
    }



    function handleLogin() {
        const user = document.getElementById('username').value.trim();
        if (!user) return Swal.fire('Opps', 'Isi nama dulu', 'warning');
        
        localStorage.setItem('activeUser', user.toLowerCase());
        document.getElementById('display-name').innerText = user;
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('main-dashboard').classList.remove('hidden');

        const isAdmin = (user.toLowerCase() === 'admin');
        if(isAdmin) {
            document.getElementById('admin-add-btn').classList.remove('hidden');
            document.getElementById('admin-view-orders').classList.remove('hidden');
            document.getElementById('cart-section').classList.add('hidden');
            document.getElementById('admin-order-section').classList.remove('hidden');
            document.getElementById('role-title').innerText = "Admin Store";
            loadOrders();
        } else {
            document.getElementById('admin-add-btn').classList.add('hidden');
            document.getElementById('admin-view-orders').classList.add('hidden');
            document.getElementById('cart-section').classList.remove('hidden');
            document.getElementById('admin-order-section').classList.add('hidden');
            document.getElementById('role-title').innerText = "Pelanggan";
        }
        loadProducts();
    }

    function handleLogout() {
        localStorage.removeItem('activeUser');
        location.reload();
    }

    async function sendData(payload) {
        return fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            cache: 'no-cache',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
    }

    async function openAddProductModal() {
        const { value: f } = await Swal.fire({
            title: '<span class="text-2xl font-extrabold text-slate-800">Tambah Menu Baru</span>',
            html: `
                <div class="text-left space-y-4 p-2">
                    <div>
                        <label class="text-[10px] font-bold text-blue-600 uppercase tracking-widest ml-1">Nama Produk</label>
                        <input id="n" class="w-full p-4 mt-1 rounded-2xl border-2 border-slate-100 outline-none focus:border-blue-500 transition-all font-bold" placeholder="Contoh: Nasi Goreng">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-blue-600 uppercase tracking-widest ml-1">Harga (Angka Saja)</label>
                        <input id="p" type="number" class="w-full p-4 mt-1 rounded-2xl border-2 border-slate-100 outline-none focus:border-blue-500 transition-all font-bold" placeholder="Contoh: 15000">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-blue-600 uppercase tracking-widest ml-1">Stok Awal</label>
                        <input id="s" type="number" class="w-full p-4 mt-1 rounded-2xl border-2 border-slate-100 outline-none focus:border-blue-500 transition-all font-bold" placeholder="Contoh: 50">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-blue-600 uppercase tracking-widest ml-1">URL Foto Produk</label>
                        <input id="i" class="w-full p-4 mt-1 rounded-2xl border-2 border-slate-100 outline-none focus:border-blue-500 transition-all text-sm font-medium" placeholder="https://image-url.com/img.jpg">
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Simpan ke Database',
            cancelButtonText: 'Batal',
            confirmButtonColor: '#0f172a', // Slate 900
            cancelButtonColor: '#f1f5f9',
            customClass: {
                popup: 'rounded-[40px]',
                confirmButton: 'rounded-2xl px-6 py-3 font-bold',
                cancelButton: 'rounded-2xl px-6 py-3 font-bold !text-slate-500'
            },
            preConfirm: () => {
                const n = document.getElementById('n').value.trim();
                const p = document.getElementById('p').value.trim();
                const s = document.getElementById('s').value.trim();
                const i = document.getElementById('i').value.trim();
                
                if(!n || !p || !s) return Swal.showValidationMessage('Nama, Harga, dan Stok wajib diisi!');
                
                return { 
                    name: n, 
                    price: p, 
                    stock: s, 
                    img: i || 'https://via.placeholder.com/400x300?text=Produk+TJKT' 
                }
            }
        });

        if (f) {
            Swal.fire({ title: 'Menyimpan...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            await sendData({ 
                action: 'add', 
                name: f.name, 
                price: f.price, 
                stock: f.stock, 
                img: f.img 
            });

            setTimeout(() => {
                loadProducts();
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil!',
                    text: 'Menu baru telah ditambahkan.',
                    timer: 2000,
                    showConfirmButton: false
                });
            }, 2000);
        }
    }
    async function deleteProduct(id) {
        if(confirm('Hapus?')) {
            await sendData({ action: 'delete', id });
            setTimeout(() => loadProducts(), 1000);
        }
    }

    function addToCart(id) {
        const p = products.find(x => x.id == id);
        if (!p || p.stock <= 0) return Swal.fire('Habis', 'Stok nol', 'error');
        const inCart = cart.find(x => x.id == id);
        if (inCart) inCart.qty++; else cart.push({ ...p, qty: 1 });
        p.stock--;
        updateCartUI();
    }

    // FUNGSI UNTUK MENGURANGI/CANCEL ITEM DI KERANJANG
    function removeFromCart(id) {
        const index = cart.findIndex(x => x.id == id);
        if (index !== -1) {
            const item = cart[index];
            const product = products.find(x => x.id == id);
            
            if (item.qty > 1) {
                item.qty--; // Kurangi jumlahnya
            } else {
                cart.splice(index, 1); // Hapus dari keranjang jika tinggal 1
            }
            
            if (product) product.stock++; // Kembalikan stoknya ke daftar produk
            updateCartUI();
        }
    }

    // UPDATE UI KERANJANG DENGAN TOMBOL CANCEL (X)
    function updateCartUI() {
        const list = document.getElementById('cart-items');
        let total = 0;
        
        list.innerHTML = cart.map(item => {
            const oriPrice = Number(item.price);
            const disc = Number(item.discount || 0);
            const finalPrice = oriPrice - disc;
            total += finalPrice * item.qty;

            return `
                <div class="flex justify-between items-center text-sm border-b border-white/5 pb-3 group">
                    <div class="flex flex-col">
                        <span class="font-extrabold text-white uppercase text-[11px] tracking-wider">${item.name}</span>
                        <span class="text-[10px] text-slate-500 font-bold">${item.qty}x @ Rp ${finalPrice.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-blue-400">Rp ${(finalPrice * item.qty).toLocaleString('id-ID')}</span>
                        <button onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-white bg-red-500/10 hover:bg-red-500 w-6 h-6 rounded-lg transition-all flex items-center justify-center font-bold text-[10px]" title="Undo/Hapus">‚úï</button>
                    </div>
                </div>`;
        }).join('');
        
        if (cart.length === 0) list.innerHTML = '<p class="text-slate-500 text-center text-sm italic py-4">Keranjang kosong...</p>';
        document.getElementById('total-price').innerText = `Rp ${total.toLocaleString('id-ID')}`;
        document.getElementById('cart-count').innerText = cart.reduce((a,b) => a + b.qty, 0);
    }

    async function checkout() {
        if (cart.length === 0) return;
        const total = cart.reduce((a, b) => a + (Number(b.price) * b.qty), 0);
        const detail = cart.map(x => `${x.qty}x ${x.name}`).join(", ");
        const qr = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=DANA_082315522328_NOMINAL_${total}`;

        Swal.fire({
            title: 'Checkout',
            html: `<p class="text-sm mb-4">Total: <b class="text-2xl text-blue-600 font-black">Rp ${total.toLocaleString('id-ID')}</b></p><img src="${qr}" class="mx-auto w-48 shadow-xl rounded-2xl border-4 border-white">`,
            showCancelButton: true, confirmButtonText: 'Konfirmasi Bayar'
        }).then(async (res) => {
            if (res.isConfirmed) {
                Swal.fire({ title: 'Kirim...', didOpen: () => Swal.showLoading() });
                await sendData({ action: 'checkout', user: localStorage.getItem('activeUser'), detail, total });
                setTimeout(() => { Swal.fire('Berhasil!', 'Order sudah masuk ke admin.', 'success'); cart = []; updateCartUI(); }, 1500);
            }
        });
    }

    function toggleOrderMonitor() {
        const mon = document.getElementById('admin-order-section');
        mon.classList.toggle('hidden');
    }
</script>
</body>
</html>